-- ULTIMATE KNIFE THROW BUTTON - Full Game Integration
if not _G.UltimateThrow then
    _G.UltimateThrow = true
    
    local Players = game:GetService("Players")
    local UserInputService = game:GetService("UserInputService")
    local player = Players.LocalPlayer
    
    -- Create the throw button
    local gui = Instance.new("ScreenGui")
    gui.Name = "UltimateThrowGUI"
    gui.ResetOnSpawn = false
    
    local button = Instance.new("TextButton")
    button.Name = "ThrowBtn"
    button.Size = UDim2.new(0, 80, 0, 80)
    button.Position = UDim2.new(0.8, 0, 0.7, 0)
    button.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    button.BackgroundTransparency = 0.3
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Text = "THROW"
    button.TextScaled = true
    button.Font = Enum.Font.GothamBold
    button.BorderSizePixel = 0
    button.Visible = false
    
    -- Make it look nice
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.2, 0)
    corner.Parent = button
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(0, 0, 0)
    stroke.Thickness = 2
    stroke.Parent = button
    
    button.Parent = gui
    gui.Parent = player:WaitForChild("PlayerGui")
    
    -- Dragging functionality
    local dragging = false
    local dragStart, startPos
    
    button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = button.Position
        end
    end)
    
    button.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.Touch then
            local delta = input.Position - dragStart
            button.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- ULTIMATE THROW FUNCTION - Based on exact game code analysis
    local function ultimateThrow()
        local character = player.Character
        if not character then 
            print("âŒ No character found")
            return 
        end
        
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then 
            print("âŒ No HumanoidRootPart found")
            return 
        end
        
        -- Find knife tool in backpack
        local backpack = player:FindFirstChild("Backpack")
        if not backpack then 
            print("âŒ No backpack found")
            return 
        end
        
        local knifeTool = nil
        
        -- Look for ANY knife tool (we know it should have Throw remote)
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") then
                knifeTool = tool
                break
            end
        end
        
        if knifeTool then
            print("ðŸ”ª Found knife: " .. knifeTool.Name)
            
            -- Get the Throw remote (this is what triggers everything)
            local throwRemote = knifeTool:FindFirstChild("Throw")
            
            if throwRemote and throwRemote:IsA("RemoteEvent") then
                -- Calculate throw trajectory based on game physics
                local position = humanoidRootPart.Position
                local lookVector = humanoidRootPart.CFrame.LookVector
                
                -- Create target position (forward + slight upward arc)
                local targetPosition = position + (lookVector * 50)
                targetPosition = Vector3.new(targetPosition.X, targetPosition.Y + 2, targetPosition.Z)
                
                -- Create proper CFrame for throwing
                local throwCFrame = CFrame.new(position, targetPosition)
                
                -- FIRE THE THROW REMOTE - This triggers everything:
                -- 1. Server creates "ThrowingServerKnife" or "ThrowingKnifeServer"
                -- 2. ThrowingKnifeVisuals script detects the new knife
                -- 3. Visual effects and physics are applied automatically
                throwRemote:FireServer(throwCFrame, targetPosition)
                
                print("âœ… Throw remote fired! Server should create throwing knife...")
                
                -- Visual feedback
                local originalColor = button.BackgroundColor3
                button.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
                
                task.delay(0.2, function()
                    button.BackgroundColor3 = originalColor
                end)
                
            else
                print("âŒ No Throw remote found in: " .. knifeTool.Name)
                print("ðŸ“ Tool contents:")
                for _, child in pairs(knifeTool:GetChildren()) do
                    print("   - " .. child.Name .. " (" .. child.ClassName .. ")")
                end
            end
        else
            print("âŒ No knife tool found in backpack")
            print("ðŸ“ Backpack contents:")
            for _, item in pairs(backpack:GetChildren()) do
                print("   - " .. item.Name .. " (" .. item.ClassName .. ")")
            end
        end
    end
    
    button.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            if not dragging then
                ultimateThrow()
            end
            dragging = false
        end
    end)
    
    -- Show button only when player has a knife and is alive
    local function updateButtonVisibility()
        local character = player.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                -- Check backpack for ANY tool (assume it's a knife)
                local backpack = player:FindFirstChild("Backpack")
                local hasTool = false
                
                if backpack then
                    for _, item in pairs(backpack:GetChildren()) do
                        if item:IsA("Tool") then
                            hasTool = true
                            break
                        end
                    end
                end
                
                button.Visible = hasTool
            else
                button.Visible = false
            end
        else
            button.Visible = false
        end
    end
    
    -- Update visibility every second
    while true do
        updateButtonVisibility()
        task.wait(1)
    end
    
    print("ðŸŽ¯ ULTIMATE throw button loaded!")
    print("â€¢ Based on exact game code analysis")
    print("â€¢ Uses the real Throw remote event")
    print("â€¢ Works with ThrowingKnifeVisuals system")
    print("â€¢ Drag to move, tap to throw instantly")
end
